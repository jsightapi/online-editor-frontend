version: 2.1
orbs:
  docker: circleci/docker@2.0.3
  common: jsight/common-ci@1.2.4


parameters:
  image-tag:
    type: string
    default: ${CIRCLE_BRANCH/\//_}_${CIRCLE_SHA1}


workflows:
  release-tag:
    when:
      matches:
        pattern: "^release-.*"
        value: << pipeline.git.tag >>
    jobs:
      - common/save-version-numbers:
          filters: &release-tag-filter
            tags:
              only: /^release-.*/
      - docker/publish:
          filters: *release-tag-filter
          requires:
            - common/save-version-numbers
          executor: common/vm-medium
          context: &common-context online-editor-development
          image: jsight/online-editor-frontend
          tag: '${FULL_VERSION_TAG},${MAJOR_VERSION_TAG},latest'
          extra_build_args: '--build-arg GTM_ID=${PROD_GTM_ID}'
          attach-at: /tmp/workspace
          before_build:
            - run:
                name: Read version number tags from workspace
                command: |
                  echo "Versions read: $(cat /tmp/workspace/full-version) , $(cat /tmp/workspace/major-version)"
                  echo "export FULL_VERSION_TAG=$(cat /tmp/workspace/full-version)" >> $BASH_ENV
                  echo "export MAJOR_VERSION_TAG=$(cat /tmp/workspace/major-version)" >> $BASH_ENV
      - approve-production-deploy:
          filters: *release-tag-filter
          type: approval
          requires:
            - docker/publish
      - common/refresh-container:
          filters: *release-tag-filter
          requires:
            - approve-production-deploy
          context: *common-context
          host: ${HOST_PROD}
          host-port: 8091
          container-name: online-editor-frontend
          image: jsight/online-editor-frontend
          tag: latest
      - common/notify-telegram:
          filters: *release-tag-filter
          requires:
            - common/refresh-container
          context: *common-context
          message: Production editor frontend updated from tag << pipeline.git.tag >>

  rc-branch:
    when:
      matches:
        pattern: "^rc/.*"
        value: << pipeline.git.branch >>
    jobs:
      - docker/publish: &dev-publish
          context: *common-context
          executor: common/vm-medium
          image: &dev-image jsight/dev-online-editor-frontend
          tag: '<< pipeline.parameters.image-tag >>,stage_latest'

      - common/refresh-container: &dev-refresh
          requires:
            - docker/publish
          context: *common-context
          container-name: online-editor-frontend
          host-port: 8091
          host: ${HOST_STAGE}
          image: *dev-image
          tag: << pipeline.parameters.image-tag >>

      - common/notify-telegram: &dev-notify
          requires:
            - common/refresh-container
          context: *common-context
          message: Stage editor frontend updated from branch ${CIRCLE_BRANCH} (commit ${CIRCLE_SHA1})

  dev-branch:
    when:
      equal: [ dev, << pipeline.git.branch >>]
    jobs:
      - docker/publish:
          <<: *dev-publish
          tag: '<< pipeline.parameters.image-tag >>,dev_latest'
      - common/refresh-container:
          <<: *dev-refresh
          host: ${HOST_DEV}
      - common/notify-telegram:
          <<: *dev-notify
          message: Dev editor frontend updated from branch ${CIRCLE_BRANCH} (commit ${CIRCLE_SHA1})

  experimental:
    when:
      matches:
        pattern: "^try/.*"
        value: << pipeline.git.branch >>
    jobs:
      - approve-go-crazy:
          type: approval
      - docker/publish:
          <<: *dev-publish
          requires:
            - approve-go-crazy
          tag: '<< pipeline.parameters.image-tag >>'
      - common/refresh-container:
          <<: *dev-refresh
          host: ${HOST_CRAZY}
      - common/notify-telegram:
          <<: *dev-notify
          message: Experimental (crazy) editor frontend updated from branch ${CIRCLE_BRANCH} (commit ${CIRCLE_SHA1})

  ci-test:
    when:
      equal: [ ci-test, << pipeline.git.branch >> ]
    jobs:
      - docker/publish:
          <<: *dev-publish
          tag: '<< pipeline.parameters.image-tag >>,ci_latest'
      - common/refresh-container:
          <<: *dev-refresh
          host: ${HOST_CRAZY}
      - common/notify-telegram:
          <<: *dev-notify
          message: Crazy editor frontend updated from branch ${CIRCLE_BRANCH} (commit ${CIRCLE_SHA1})