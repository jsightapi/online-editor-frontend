version: 2.1
orbs:
  docker: circleci/docker@2.0.3
  jira: circleci/jira@1.3.1
  common: jsight/common-ci@1.3.0


parameters:
  image-tag:
    type: string
    default: ${CIRCLE_BRANCH/\//_}_${CIRCLE_SHA1}


workflows:
  release-tag:
    when:
      matches:
        pattern: "^release-.*"
        value: << pipeline.git.tag >>
    jobs:
      - docker/publish:
          filters: &release-tag-filter
            tags:
              only: /^release-.*/
          executor: common/vm-medium
          context: &common-context online-editor-development
          image: jsight/online-editor-frontend
          tag: '${FULL_VERSION},${MAJOR_VERSION},latest' # values available thx to pre-steps
          extra_build_args: '--build-arg GTM_ID=${PROD_GTM_ID}'
          pre-steps:
            - common/parse-versions
      - approve-production-deploy:
          filters: *release-tag-filter
          type: approval
          requires:
            - docker/publish
      - common/refresh-container:
          filters: *release-tag-filter
          requires:
            - approve-production-deploy
          context: *common-context
          host: ${HOST_PROD}
          host-port: 8091
          container-name: online-editor-frontend
          image: jsight/online-editor-frontend
          tag: latest
          post-steps:
            - jira/notify:
                job_type: deployment
                environment_type: production
                environment: Production

      - common/notify-telegram:
          filters: *release-tag-filter
          requires:
            - common/refresh-container
          context: *common-context
          message: Production editor frontend updated from tag << pipeline.git.tag >>

  rc-branch:
    when:
      matches:
        pattern: "^rc/.*"
        value: << pipeline.git.branch >>
    jobs:
      - docker/publish: &dev-publish
          context: *common-context
          executor: common/vm-medium
          image: &dev-image jsight/dev-online-editor-frontend
          tag: '<< pipeline.parameters.image-tag >>,stage_latest'

      - common/refresh-container: &dev-refresh
          requires:
            - docker/publish
          context: *common-context
          container-name: online-editor-frontend
          host-port: 8091
          host: ${HOST_STAGE}
          image: *dev-image
          tag: << pipeline.parameters.image-tag >>
          post-steps:
            - jira/notify:
                job_type: deployment
                environment_type: staging
                environment: Staging

      - common/notify-telegram: &dev-notify
          requires:
            - common/refresh-container
          context: *common-context
          message: Stage editor frontend updated from branch ${CIRCLE_BRANCH} (commit ${CIRCLE_SHA1})

  dev-branch:
    when:
      equal: [ dev, << pipeline.git.branch >>]
    jobs:
      - docker/publish:
          <<: *dev-publish
          tag: '<< pipeline.parameters.image-tag >>,dev_latest'
      - common/refresh-container:
          <<: *dev-refresh
          host: ${HOST_DEV}
          post-steps:
            - jira/notify:
                job_type: deployment
                environment_type: testing
                environment: Test
      - common/notify-telegram:
          <<: *dev-notify
          message: Dev editor frontend updated from branch ${CIRCLE_BRANCH} (commit ${CIRCLE_SHA1})

  experimental:
    when:
      matches:
        pattern: "^try/.*"
        value: << pipeline.git.branch >>
    jobs:
      - approve-go-crazy:
          type: approval
      - docker/publish:
          <<: *dev-publish
          requires:
            - approve-go-crazy
          tag: '<< pipeline.parameters.image-tag >>'
      - common/refresh-container:
          <<: *dev-refresh
          host: ${HOST_CRAZY}
          post-steps:
            - jira/notify:
                job_type: deployment
                environment_type: testing
                environment: Experimental # Test, Production, Staging
      - common/notify-telegram:
          <<: *dev-notify
          message: Experimental (crazy) editor frontend updated from branch ${CIRCLE_BRANCH} (commit ${CIRCLE_SHA1})

  ci-test:
    when:
      equal: [ ci-test, << pipeline.git.branch >> ]
    jobs:
      - docker/publish:
          <<: *dev-publish
          tag: '<< pipeline.parameters.image-tag >>,ci_latest'
      - common/refresh-container:
          <<: *dev-refresh
          host: ${HOST_CRAZY}
      - common/notify-telegram:
          <<: *dev-notify
          message: Crazy editor frontend updated from branch ${CIRCLE_BRANCH} (commit ${CIRCLE_SHA1})
